name: ZAP Authenticated Full Scan (Seeded SPA Routes)

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  zap-full-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Prepare workspace
      run: |
        chmod -R 777 .
        mkdir -p zap-output

    - name: Run ZAP Full Authenticated Scan (Seeded)
      run: |
        docker run --rm \
          -v "$(pwd):/zap/wrk" \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py \
          -t https://valuelabs-admin.adhoc.stabilthus.io \
          -r zap-report.html \
          -x zap-report.xml \
          -j \
          -I \
          -d \
          -a \
          \
          -s https://valuelabs-admin.adhoc.stabilthus.io/dashboard \
          -s https://valuelabs-admin.adhoc.stabilthus.io/accounts \
          -s https://valuelabs-admin.adhoc.stabilthus.io/accounts/accounts \
          -s https://valuelabs-admin.adhoc.stabilthus.io/activity \
          -s https://valuelabs-admin.adhoc.stabilthus.io/activity/access-history \
          -s https://valuelabs-admin.adhoc.stabilthus.io/audit-logs \
          -s https://valuelabs-admin.adhoc.stabilthus.io/blockchains \
          -s https://valuelabs-admin.adhoc.stabilthus.io/blockchains/pending-transactions-list \
          -s https://valuelabs-admin.adhoc.stabilthus.io/compliance \
          -s https://valuelabs-admin.adhoc.stabilthus.io/compliance/manual-review-list \
          -s https://valuelabs-admin.adhoc.stabilthus.io/crypto \
          -s https://valuelabs-admin.adhoc.stabilthus.io/crypto/treasury-transfer \
          -s https://valuelabs-admin.adhoc.stabilthus.io/custody-fees \
          -s https://valuelabs-admin.adhoc.stabilthus.io/fiat \
          -s https://valuelabs-admin.adhoc.stabilthus.io/fiat/bank-list \
          -s https://valuelabs-admin.adhoc.stabilthus.io/fund-management \
          -s https://valuelabs-admin.adhoc.stabilthus.io/fund-management/fund-subscriptions \
          -s https://valuelabs-admin.adhoc.stabilthus.io/generate-sumsub \
          -s https://valuelabs-admin.adhoc.stabilthus.io/generate-sumsub/new \
          -s https://valuelabs-admin.adhoc.stabilthus.io/health-check \
          -s https://valuelabs-admin.adhoc.stabilthus.io/health-check/failing-checks \
          -s https://valuelabs-admin.adhoc.stabilthus.io/historical \
          -s https://valuelabs-admin.adhoc.stabilthus.io/historical/summary \
          -s https://valuelabs-admin.adhoc.stabilthus.io/hsm \
          -s https://valuelabs-admin.adhoc.stabilthus.io/hsm-secure-sign \
          -s https://valuelabs-admin.adhoc.stabilthus.io/invoices \
          -s https://valuelabs-admin.adhoc.stabilthus.io/kpis \
          -s https://valuelabs-admin.adhoc.stabilthus.io/organizations \
          -s https://valuelabs-admin.adhoc.stabilthus.io/pro-trading-referential \
          -s https://valuelabs-admin.adhoc.stabilthus.io/prospects \
          -s https://valuelabs-admin.adhoc.stabilthus.io/quorum \
          -s https://valuelabs-admin.adhoc.stabilthus.io/quorum/pending-quorum-operations \
          -s https://valuelabs-admin.adhoc.stabilthus.io/referential \
          -s https://valuelabs-admin.adhoc.stabilthus.io/rewards \
          -s https://valuelabs-admin.adhoc.stabilthus.io/settings \
          -s https://valuelabs-admin.adhoc.stabilthus.io/sites \
          -s https://valuelabs-admin.adhoc.stabilthus.io/talos-settlement/dashboard \
          -s https://valuelabs-admin.adhoc.stabilthus.io/tenants \
          -s https://valuelabs-admin.adhoc.stabilthus.io/trading \
          -s https://valuelabs-admin.adhoc.stabilthus.io/treasury \
          -s https://valuelabs-admin.adhoc.stabilthus.io/users \
          -s https://valuelabs-admin.adhoc.stabilthus.io/yield \
          \
          -z "-config spider.maxDuration=120 \
              -config spider.maxDepth=10 \
              -config spider.postform=true \
              -config spider.processform=true \
              -config ajaxSpider.maxDuration=60 \
              -config ajaxSpider.maxCrawlDepth=20 \
              -config ajaxSpider.clickDefaultElements=true \
              -config ajaxSpider.clickElementsOnce=false \
              -config ajaxSpider.browserId=firefox \
              -config ajaxSpider.inScopeOnly=false \
              -config scanner.excludeurls=^https://valuelabs-admin\.adhoc\.stabilthus\.io/logout$ \
              -config replacer.full_list(0).description=AddAuthCookies \
              -config replacer.full_list(0).enabled=true \
              -config replacer.full_list(0).matchtype=REQ_HEADER \
              -config replacer.full_list(0).matchstr=Cookie \
              -config replacer.full_list(0).regex=false \
              -config replacer.full_list(0).replacement=<PUT_YOUR_FULL_COOKIE_STRING_HERE>"

    - name: Upload ZAP HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-html-report
        path: zap-report.html

    - name: Upload ZAP XML Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-xml-report
        path: zap-report.xml
